// Set this to the directory where you have node sources
// The test uses node's test certificates for the TLS server
var PATH_TO_NODE_SOURCES = '/Users/bajtos/src/node';

/** Usage **
1. Start a SSL server in terminal 1
  $ openssl s_server -cert test_cert.pem -key test_key.pem
  (..lots of SSL logs..)

2. Run the client in terminal 2 - don't reuse sessions
  $ node client.js
  session reused: false

3. Run the client again and reuse sessions
  $ node client.js reuse
  session reused: true

*/  

// IMPLEMENTATION

var fs = require('fs');
var path = require('path');
var tls = require('tls');

var cert_dir = path.resolve(PATH_TO_NODE_SOURCES, 'test', 'fixtures');
var reuse = process.argv.some(function(a) { return a === 'reuse'; });
var port = Number(process.argv[2]) || 4433;

function makeConnections(num, session) {
  var opts = {
      port: port,
      ca: [ fs.readFileSync(cert_dir + '/test_ca.pem') ],
    };

  if (reuse)
    opts.session = session;

  var conn = tls.connect(opts, function() {
    conn.end();
    if (num > 1) {
      makeConnections(num-1, conn.getSession());
    } else {
      console.log('session reused:', conn.isSessionReused());
    }
  });
}

makeConnections(2);
